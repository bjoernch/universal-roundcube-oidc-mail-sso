services:
  db:
    image: mariadb:11
    container_name: rc_oidc_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - rc_db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "127.0.0.1", "-u${DB_USER}", "-p${DB_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 10

  roundcube:
    image: roundcube/roundcubemail:latest
    container_name: rc_oidc_app
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "${ROUNDCUBE_PORT}:80"
    environment:
      ROUNDCUBEMAIL_DEFAULT_HOST: ${DEFAULT_IMAP_URI}
      ROUNDCUBEMAIL_DEFAULT_PORT: ${DEFAULT_IMAP_PORT}
      ROUNDCUBEMAIL_SMTP_SERVER: ${DEFAULT_SMTP_URI}
      ROUNDCUBEMAIL_SMTP_PORT: ${DEFAULT_SMTP_PORT}
      ROUNDCUBEMAIL_PLUGINS: "universal_oidc_mail_sso"
      ROUNDCUBEMAIL_DB_TYPE: mysql
      ROUNDCUBEMAIL_DB_HOST: db
      ROUNDCUBEMAIL_DB_PORT: 3306
      ROUNDCUBEMAIL_DB_NAME: ${DB_NAME}
      ROUNDCUBEMAIL_DB_USER: ${DB_USER}
      ROUNDCUBEMAIL_DB_PASSWORD: ${DB_PASSWORD}
      OIDC_ISSUER: ${OIDC_ISSUER}
      OIDC_CLIENT_ID: ${OIDC_CLIENT_ID}
      OIDC_CLIENT_SECRET: ${OIDC_CLIENT_SECRET}
      OIDC_REDIRECT_URI: ${OIDC_REDIRECT_URI}
      OIDC_POST_LOGOUT_REDIRECT_URI: ${OIDC_POST_LOGOUT_REDIRECT_URI}
      OIDC_SCOPES: ${OIDC_SCOPES}
      ALLOWED_ISSUERS: ${ALLOWED_ISSUERS}
      METADATA_PIN_SHA256: ${METADATA_PIN_SHA256}
      ALLOWED_EMAIL_DOMAIN: ${ALLOWED_EMAIL_DOMAIN}
      ALLOW_CUSTOM_MAILBOX_EMAIL: ${ALLOW_CUSTOM_MAILBOX_EMAIL}
      ADMIN_GROUP_NAME: ${ADMIN_GROUP_NAME}
      USER_GROUP_NAME: ${USER_GROUP_NAME}
      ADMIN_EMAILS: ${ADMIN_EMAILS}
      RCUBE_MAILBOX_KEY: ${RCUBE_MAILBOX_KEY}
      RCUBE_MAILBOX_KEYS: ${RCUBE_MAILBOX_KEYS}
      RCUBE_MAILBOX_KEY_ID: ${RCUBE_MAILBOX_KEY_ID}
      FORCE_HTTPS: ${FORCE_HTTPS}
      DISABLE_PASSWORD_LOGIN: ${DISABLE_PASSWORD_LOGIN}
      LOGIN_MODE: ${LOGIN_MODE}
      HIDE_STANDARD_LOGIN_FORM: ${HIDE_STANDARD_LOGIN_FORM}
      LOGIN_BUTTON_TEXT: ${LOGIN_BUTTON_TEXT}
      CLIENT_SIDE_WRAP_ENABLED: ${CLIENT_SIDE_WRAP_ENABLED}
      SESSION_IDLE_TIMEOUT_SEC: ${SESSION_IDLE_TIMEOUT_SEC}
      SESSION_ABSOLUTE_TIMEOUT_SEC: ${SESSION_ABSOLUTE_TIMEOUT_SEC}
      LOGIN_RATE_LIMIT_PER_5M: ${LOGIN_RATE_LIMIT_PER_5M}
      CALLBACK_RATE_LIMIT_PER_5M: ${CALLBACK_RATE_LIMIT_PER_5M}
      SETUP_RATE_LIMIT_PER_5M: ${SETUP_RATE_LIMIT_PER_5M}
      AUTH_LOCK_SECONDS: ${AUTH_LOCK_SECONDS}
      DEFAULT_IMAP_HOST: ${DEFAULT_IMAP_HOST}
      DEFAULT_IMAP_PORT: ${DEFAULT_IMAP_PORT}
      DEFAULT_IMAP_SECURITY: ${DEFAULT_IMAP_SECURITY}
      DEFAULT_SMTP_HOST: ${DEFAULT_SMTP_HOST}
      DEFAULT_SMTP_PORT: ${DEFAULT_SMTP_PORT}
      DEFAULT_SMTP_SECURITY: ${DEFAULT_SMTP_SECURITY}
      DEFAULT_SMTP_AUTH: ${DEFAULT_SMTP_AUTH}
    volumes:
      - ./plugins/universal_oidc_mail_sso:/var/www/html/plugins/universal_oidc_mail_sso

volumes:
  rc_db_data:
